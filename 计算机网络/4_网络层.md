**网络层功能概述**

主要任务是把<font color="crimson">分组</font>从源端传到目的端，为分组交换网上的不同主机提供通信服务。网络层传输单位是<font color="crimson">数据报</font>。

1、路由选择与分组转发

2、异构网络互联

3、拥塞控制

---

**数据交换方式**

<div align=left><img src="C:\Users\1979\AppData\Roaming\Typora\typora-user-images\image-20210720180855954.png"></div>

**<font color="firebrick"> 电路交换</font>**

在进行数据传输时，两个结点之间必须先建立一条专用（双方独占）的物理通信路径（由通信双方之间的交换设备和链路逐段连接而成），该路径可能经过许多中间结点。这一路径在整个数据传输期间一直被独占，直到通信结束后才被释放。

电路交换的阶段：<font color="crimson">建立连接</font>、<font color="forestgreen">数据传输</font>、<font color="goldenrod">释放连接</font>。

电路交换的关键点是，在数据传输的过程中，<font color="darkseag">用户始终占用端到端的固定传输带宽</font>。

<font color="forestgreen">电路交换技术的优点</font>：

1、<font color="dodgerblue">通信时延小</font>。由于通信线路为通信双方用户专用，数据直达，因此传输数据的时延非常小。当传输的数据量较大时，这一优点非常明显。

2、<font color="dodgerblue">有序传输</font>。双方通信时按发送顺序传送数据，不存在失序问题。

3、<font color="dodgerblue">没有冲突</font>。不同的通信双方拥有不同的信道，不会出现争用物理信道的问题。

4、<font color="dodgerblue">适用范围广</font>。电路交换既适用于传输模拟信号，又适用于传输数字信号。

5、<font color="dodgerblue">实时性强</font>。通信双方之间的物理通路一旦建立，双方就可以随时通信。

6、<font color="dodgerblue">控制简单</font>。电路交换的交换设备及控制均较简单。

<font color="crimson">电路交换的缺点</font>：

1、<font color="dodgerblue">建立连接时间</font>长。电路交换的平均连接建立时间对计算机通信来说太长。

2、<font color="dodgerblue">线路独占，使用效率低</font>。电路交换连接建立后，物理通路被通信双方独占，即使通信线路空闲，也不能供其他用户使用，因而信道利用率低。

3、<font color="dodgerblue">灵活性差</font>。只要在通信双方建立的通路中的任何一点出了故障，就必须重新拨号建立新的连接，这对十分紧急和重要的通信是很不利的。

4、<font color="dodgerblue">难以规格化</font>。电路交换时，数据直达，不同类型、不同规格、不同速率的终端很难相互进行通信，也难以在通信过程中进行差错控制。

**<font color="firebrick"> 报文交换</font>**

数据交换的单位是报文，报文携带有目标地址、源地址等信息。

报文交换在交换结点采用的是存储转发的传输方式。

<font color="forestgreen">报文交换的优点</font>：

1、<font color="dodgerblue">无需建立连接</font>。报文交换不需要为通信双方预先建立一条专用的通信线路，不存在建立连接时延，用户可以随时发送报文。

2、<font color="dodgerblue">动态分配线路</font>。当发送方把报文交给交换设备时，交换设备先存储整个报文，然后选择一条合适的空闲线路，将报文发送出去。

3、<font color="dodgerblue">提高线路可靠性</font>。如果某条传输路径发生故障，那么可重新选择另一条路径传输数据，因此提高了传输的可靠性。

4、<font color="dodgerblue">提高线路利用率</font>。通信双方不是固定占有一条通信线路，而是在不同的时间一段一段地部分占有这条物理通道，因而大大提高了通信线路的利用率。

5、<font color="dodgerblue">提供多目标服务</font>。一个报文可以同时发送给多个目的地址，这在电路交换中是很难实现的。

<font color="crimson">报文交换的缺点</font>：

1、由于数据进入交换结点后要经历存储、转发这一过程，因此会引起<font color="dodgerblue">转发时延</font>。

2、报文交换对报文的大小没有限制，这就要求网络结点需要有较大的<font color="dodgerblue">缓存空间</font>。

**<font color="firebrick"> 同报文交换一样，分组交换也采用存储转发方式，但解决了报文交换中大报文传输的问题。

分组交换限制了每次传送的数据块大小的上限，把大的数据块划分为合理的小数据块，在加上一些必要的控制信息（如源地址、目的地址和编号信息等），构成分组。

<font color="forestgreen">分组交换的优点</font>：

1、<font color="dodgerblue">无建立时延</font>。不需要为通信双方预先建立一条专用的通信线路，不存在建立连接时延，用户可以随时发送分组。

2、<font color="dodgerblue">线路利用率高</font>。通信双方不是固定占有一条通信线路，而是在不同的时间一段一段地部分占有这条物理通道，因而大大提高了通信线路的利用率。

3、<font color="dodgerblue">简化了存储管理（相对于报文交换）</font>。因为分组的长度固定，相应的缓冲区的大小也固定，在交换结点中存储器的管理通常被简化为对缓冲区的管理，相对比较容易。

4、<font color="dodgerblue">加速传输</font>。分组时逐个传输的，可以使后一个分组的存储操作与前一个分组的转发操作并行，这种流水线方式减少了报文的传输时间。此外，传输一个分组所需的缓冲区比传输一次报文所需的缓冲区小得多，这样因缓冲区不足而等待发送的概率及时间也必然少得多。

5、<font color="dodgerblue">减少了出错概率和重发数据量</font>。因为分组较短，其出错概率必然减小，所以每次重发的数据量也就大大减少，这样不仅提高了可靠性，也减少了传输时延。

<font color="crimson">分组交换的缺点</font>：

1、<font color="dodgerblue">存在传输时延</font>。尽管分组交换比报文交换的传输时延少，但相对于电路交换仍存在存储转发时延，而且其结点交换机必须具有更强的处理能力。

2、<font color="dodgerblue">需要传输额外的信息量</font>。每个小数据块都要加上源地址、目的地址和分组编号等信息。从而构成分组，因此使得传送的信息量增大了 5% ~ 10%，一定程度上降低了通信效率，增加了处理的时间，使控制复杂，时延增加。

3、当分组交换采用数据报服务时，可能会出现失序、丢失或重复分组，分组达到目的结点时，要对分组按编号进行排序等工作，因此很麻烦。若采用虚电路服务，虽无失序问题，但有呼叫建立、数据传输和虚电路释放三个过程。

<font color="goldenrod">imp.</font>

1、<font color="forestgreen">报文交换</font>和<font color="dodgerblue">分组交换</font>都采用存储转发。

2、传送数据量大，且传送时间远大于呼叫时间，选择<font color="goldenrod">电路交换</font>。电路交换传输时延最小。

3、从信道利用率看，<font color="forestgreen">报文交换</font>和<font color="dodgerblue">分组交换</font>优于<font color="goldenrod">电路交换</font>，其中分组交换时延更小。

---

**数据报方式 & 虚电路方式**

数据报方式为网络层提供<font color="crimson">无连接服务</font>。

虚电路方式为网络层提供<font color="forestgreen">连接服务</font>。

<font color="crimson">无连接服务</font>：不事先为分组的传输确定传输路径，每个分组独立确定传输路径，不同分组传输路径可能不同。

<font color="forestgreen">连接服务</font>：首先为分组的传输确定传输路径（建立连接），然后沿该路径（连接）传输系列分组，系列分组传输路径相同，传输结束后拆除连接。

**<font color="firebrick"> 数据报</font>**

1、发送分组前不需要建立连接。发送方可随时发送分组，网络中的结点可随时接收分组。

2、网络尽最大努力交付，传输不保证可靠性，所以可能丢失，为每个分组独立地选择路由，转发的路径可能不同，因而分组不一定按序到达目的结点。

3、发送的分组中要包括<font color="goldenrod">发送端和接收端的完整地址</font>，以便可以独立传输。

4、分组在交换结点存储转发时，需要排队等待处理，这会带来一定的时延。通过交换结点的通信量较大或网络发生拥塞时，这种时延会大大增加，交换结点还可根据情况丢弃部分分组。

5、网络具有冗余路径，当某个交换结点或一条链路出现故障时，可相应地更新转发表，寻找另一条路径转发分组，对故障的适应能力强。

6、收发双发不独占某条链路，资源利用率较高。

<font color="forestgreen">路由器根据分组的目的地址转发分组</font>：基于路由协议/算法构建转发表；检索转发表；每个分组独立选路。

**<font color="firebrick"> 虚电路</font>**

虚电路将数据报方式和电路交换方式结合，以发挥两者优点。

虚电路：一条源主机到目的主机类似于电路的路径（逻辑连接），路径上所有结点都要维持这条虚电路的建立，都维持一张虚电路表，每一项记录了一个打开的虚电路的信息。

<font color="crimson">建立连接（虚电路建立）</font>：每个分组携带虚电路号，而非目的地址。源主机发送“呼叫请求”分组并收到“呼叫应答”分组后才算建立连接。

<font color="forestgreen">数据传输</font>：全双工通信。

<font color="dodgerblue">释放连接（虚电路释放）</font>：源主机发送“释放请求”分组以拆除虚电路。

![image-20210721114928521](C:\Users\1979\AppData\Roaming\Typora\typora-user-images\image-20210721114928521.png)

---

**路由算法**

<font color="crimson">1、静态路由算法</font>（非自适应路由算法）：指由网络管理员手工配置路由信息。

<font color="darkseag">优点</font>：<font color="forestgreen">简单、可靠</font>，在负荷稳定、拓扑变化不大的网络中运行效果很好，广泛用于高度安全性的军事网络和较小的商业网络。

<font color="darkseag">缺点</font>：当网络的拓扑结构或链路的状态发生变化时，网络管理员需要手工去修改路由表中相关的静态路由信息。它不能及时适应网络状态的变化，<font color="goldenrod">路由更新慢</font>，对于简单的小型网络，可以采用静态路由。

<font color="crimson">2、动态路由算法</font>（自适应路由算法）：指路由器上的路由表项是通过相互连接的路由器之间彼此交换信息，然后按照一定的算法优化出来的。

<font color="darkseag">优点</font>：<font color="forestgreen">路由更新快</font>。这些路由信息会在一定时间间隙里不断更新，以适应不断变化的网络，随时获得最优的寻路效果。

<font color="darkseag">缺点</font>：算法复杂，增加网络负担。

常用的动态路由算法可分为两类：<font color="forestgreen">距离-向量路由算法 OSPF </font> 和 <font color="dodgerblue">链路状态路由算法 RIP</font> 。

<font color="gainsboro"> -------------------------------------------------------------分界线---------------------------------------------------------------</font>

**层次路由**

1）当<font color="goldenrod">网络规模扩大</font>时，路由器的路由表成比例地增大。这不仅会消耗越来越多的路由器缓冲区空间，而且需要用更多CPU时间来扫描路由表，用更多的带宽来交换路由状态信息。因此路由选择必须按照层次的方式来进行。

2）许多单位不想让外界知道自己的路由选择协议，但还想连入因特网。

<font color="crimson">自治系统（Autonomous System，AS）</font>：单一技术管理下的一组路由器，这些路由器使用一种<font color="goldenrod">AS内部</font>的路由选择协议和共同的度量来确定分组在该AS内的路由，同时还使用一种<font color="goldenrod">AS之间</font>的路由选择协议来确定分组在AS之间的选择。

一个自治系统内的所有网络都由一个行政单位（如一家公司、一所大学、一个政府部门等）管辖，<font color="forestgreen">一个自治系统的所有路由器在本自治系统内都必须是连通的。</font>

因特网把路由选择协议划分为两大类：

1）一个自治系统内部所使用的路由选择协议称为 <font color="dodgerblue">内部网关协议（IGP）</font>，也称为域内路由选择，具体的协议有<font color="goldenrod">RIP</font>和<font color="goldenrod">OSPF</font>等。

２）自治系统之间所使用的路由选择协议称为 <font color="dodgerblue">外部网关协议（EGP）</font>，也称域间路由选择，在不同自治系统的路由器之间交换路由信息，并负责为分组在不同自治系统之间选择最优的路径。具体的协议有<font color="goldenrod">BGP</font>。

![image-20210721145724546](C:\Users\1979\AppData\Roaming\Typora\typora-user-images\image-20210721145724546.png)



<font color="gainsboro"> -------------------------------------------------------------分界线---------------------------------------------------------------</font>

---

**IP数据报格式**

![image-20210721152539797](C:\Users\1979\AppData\Roaming\Typora\typora-user-images\image-20210721152539797.png)

1）版本：指IP的版本，IPv4 / IPv6

2）首部长度：占4位，单位是4B。可以表示的最大十进制数是15。以32位为单位，最大值为60B（15x4B）。<font color="forestgreen">最常用的首部长度是20B</font>。

3）区分服务：指示期望获得哪种类型的服务。

4）总长度：占16位，首部 + 数据，单位是 1B。<font color="forestgreen">数据报的最大长度位 2^16 - 1 = 65535B</font>。以太网帧的最大传送单元（MTU）位1500B，因此当一个IP数据报封装成帧时，数据报的总长度一定不能超过下面的数据链路层的MTU指。

5）标识：占16位。它时一个计数器，每产生一个数据报就加1，并赋值给标识字段。当一个数据报的长度超过网络的MTU时，必须分片，此时每个数据报片都复制一次标识号，以便能正确重装成原来的数据报。<font color="forestgreen">同一数据报的分片使用同一标识</font>。

6）标志：占3位。标志字段的最低位位 MF，<font color="forestgreen">MF = 1 表示后面还有分片</font>，<font color="forestgreen">MF = 0 表示最后一个分分片</font>。标志字段中间的一位时 DF，<font color="forestgreen">只有当 DF = 1 时才允许分片</font>。

7）片偏移：占13位。它指出较长的分组在分片后，某片在原分组中的相对位置。<font color="forestgreen">片偏移以８各字节为偏移单位</font>，即每个分片的长度一定是8B（64位）的整数倍。

8）生存时间（TTL）：占8位。数据报在网络中可通过的路由器数的最大值，标识分组在网络中的寿命，以确保分组不会永远在网络中循环。<font color="forestgreen">经过一个路由器 -1，变成 0 则丢弃</font>。

9）协议：占8位。指出此分组携带的数据使用何种协议，即分组的数据部分应交给哪个传输层协议，如TCP、UDP等。<font color="forestgreen">其中值为6表示TCP，值为17表示UDP</font>。

10）首部校验和：占16位。IP数据报的首部校验和只校验分组的首部，而不校验数据部分。

11）源地址字段：占32位，标识发送方的IP地址。

12）目的地址字段：占32位，标识接收方的IP地址。

13）可选字段：0~40B，用来支持排错、测量以及安全等措施。

14）填充：全0，把首部补成4B的整数倍。

---

**IP数据报分片**

一个数据链路层数据报能承载的最大数据量称为<font color="crimson">最大传送单元（MTU）</font>。因为IP数据报被封装在数据链路层数据报中，因此数据链路层的MTU严格地限制着 IP 数据报的长度。

当IP数据报的总长度大于链路MTU时，就需要将IP数据报中的数据分装在两个或多个较小的IP数据报中，这些较小的数据报称为<font color="crimson">片</font>。

<font color="goldenrod">for example</font>

---

**IPv4地址**

<font color="crimson"> IP地址</font>：全世界唯一的<font color="dodgerblue">32位/4字节</font>标识符，标识路由器主机的接口。

IP地址:: = {<网络号>,<主机号>}

<font color="goldenrod">网络号</font>标志主机（或路由器）所连接到的网络。<font color="forestgreen">主机号</font>标志着该主机（或路由器）。

**<font color="firebrick">分类的IP地址</font>**

![](https://gitee.com/XiaoJing-C/images/raw/master/img/20210721164133.png)

在各类IP地址中，有些IIP地址具有特殊用途，<font color="darkseag">不用做主机的IP地址</font>：

![](https://gitee.com/XiaoJing-C/images/raw/master/img/20210721164530.png)

<font color="darkseag">私有IP地址</font>

路由器对目的地址是私有IP地址的数据报一律不进行转发。

采用私有IP地址的互联网络称为<font color="goldenrod">专用互联网</font>或<font color="goldenrod">本地互联网</font>。

![](https://gitee.com/XiaoJing-C/images/raw/master/img/20210721164606.png)

<font color="darkseag">常用的三种类别IP地址的使用范围</font>

![](https://gitee.com/XiaoJing-C/images/raw/master/img/20210721164739.png)

---

**网络地址转换NAT**

<font color="crimson"> 网络地址转换（NAT）</font>是指通过将专用网络地址转换为公用地址，从而对外隐藏内部管理的IP地址。它使得整个专用网只需要一个全球IP地址就可以与因特网连通，由于专用网本地IP地址是可重用的，所以NAT大大节省了IP地址的消耗。

<font color="goldenrod">私有IP地址只用于LAN，不用于WAN连接</font>（因此私有IP地址不能直接用于Internet，必须通过网关利用NAT把私有IP地址转换为Internet中合法的全球IP地址后才能用于Internet），并且允许私有IP地址被LAN重复使用。这有效地解决了IP地址不足的问题。

使用NAT时需要在专用网连接到因特网的路由器上安装NAT软件，NAT路由器至少有一个有效的外部全球地址。使用本地地址的主机和外界通信时，NAT路由器使用NAT转换表将本地地址转换成全球地址，或将全球地址转换成本地地址。<font color="goldenrod">NAT转换表中存放着{本地IP地址：端口} 到{全球IP地址：端口}的映射</font>。通过{ip地址：端口}这样的映射方式，可让多个私有IP地址映射到同一个全球IP地址。

---

**子网划分**

<font color="forestgreen">分类的IP地址的弱点：</font>

1、IP地址空间的利用率有时很低。

2、给每个物理网络分配一个网络号会使路由表变得太大而网络性能变坏。

3、两级IP地址不够灵活。

<font color="crimson">子网划分</font>：在IP地址中增加一个<font color="dodgerblue">子网号字段</font>，使两级IP地址变成了三级IP地址。

**<font color="firebrick">基本思路</font>**

1）子网划分纯属一个单位内部的事情。<u>单位对外仍然表现为没有划分子网的网络。</u>

2）从主机号借用若干比特作为子网号，当然主机号也就相应减少了相同比特。三级IP地址的结构如下：<font color="crimson">IP地址 = {<网络号>，<子网号>，<主机号>}</font>。

3）凡是从其他网络发送给本单位某台主机的IP数据报，仍然是根据IP数据报的目的网络号，先找到连接到本单位网络上的路由器。然后该路由器在收到IP数据报后，按目的网络号和子网号找到目的子网。最后把IP数据报直接交付给目的主机。

<font color="goldenrod">imp.</font>

不论是分类的IPv4地址还是CIDR，其子网中的主机号为全0或全1的地址都不能被指派。

<font color="goldenrod">子网中主机号全0的地址为子网的网络号，主机号全1的地址为子网的广播地址</font>。

---

**子网掩码**

子网掩码是一个与IP地址相对应的、长32bit的二进制串，它由一串1和跟随的一串0组成。

<font color="forestgreen">其中，1对应于IP地址中的网络号及子网号，而0对应于主机号。</font>

<font color="crimson">计算机只需将IP地址和其对应的子网掩码逐位“与”（逻辑AND运算），就可得出相应子网的网络地址。</font>

<font color="goldenrod">imp.</font>

<div align=left><img src="https://gitee.com/XiaoJing-C/images/raw/master/img/20210721184301.png" style="zoom:80%;" /></div>



<font color="dodgerblue">使用子网掩码时路由器的分组转发算法：</font>

1）从收到的分组的首部提取目的IP地址，记为D。

2）先判断是否为直接交付。对路由器直接相连的网络逐个进行检查：<font color="forestgreen">用各网络的子网掩码和D逐位相“与”，看结果是否和相应的网络地址匹配</font>。若匹配，则将分组直接交付，否则间接交付，执行步骤3）。

3）若路由器中有目的地址为D的特定主机路由，则将分组传给路由表中所指明的下一跳路由器；否则，执行步骤4）。

4）对路由表中的每一行（目的网络地址、子网掩码、下一跳地址）中的子网掩码和D逐位相“与”，其结果为N。若N与该行的目的网络地址匹配，则将分组传送给该行指明的下一跳路由器；否则，执行步骤5）。

5）若路由表中有一个默认路由，则将分组传送给路由表中所指明的默认路由器；否则，执行步骤6）。

6）报告转发分组出错。

---

**无分类域间路由选择 CIDR**

无分类域间路由选择是在变长子网掩码的基础上提出的一种消除传统 A、B、C类网络划分，并且可以在软件的支持下实现超网构造的一种IP地址的划分方法。

IP地址的无分类两级编址为：<font color="crimson">IP:: = {<网络前缀>, <主机号>}</font>

斜线记法：<font color="forestgreen">IP地址/网络前缀所占比特数</font>

其中，网络前缀所占比特数对应于网络号的部分，<font color="goldenrod">等效于子网掩码中连续1的部分</font>。

**<font color="firebrick">构成超网</font>**

将多个子网聚合成一个较大的子网，叫做<font color="crimson">构成超网</font>，或<font color="crimson">路由聚合</font>。

<font color="dodgerblue">方法</font>：将网络前缀缩短。

CIDR地址块中的地址数一定是2的整数次幂，实际可指派的地址数通常为 <font color="forestgreen">2^N - 2</font>，N 表示主机号的位数，主机号全0代表网络号，主机号全1为广播地址。

**<font color="firebrick">最长前缀匹配</font>**

使用CIDR时，路由表中的每个项目由<font color="goldenrod">“网络前缀”和“下一跳地址”</font>组成。查找路由表可能得到几个匹配结果，<font color="goldenrod">应选择具有最长网络前缀的路由</font>。前缀越长，地址块越小，路由越具体。

---

**ARP协议**



